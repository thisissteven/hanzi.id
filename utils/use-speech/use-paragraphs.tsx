// const sentence = `
//   A cat is a small carnivorous mammal. It is the only domesticated species in the family Felidae. It is often referred to as the domestic cat to distinguish it from wild members of the family.
// `;

import { franc } from "franc";
import React from "react";

const sentence = cleanUpText(`第一章  第一节
　　九月十日，星期二的放学后。
　　头顶上方传来“砰”的一声，我反射动作的抬起头，见到三楼窗户丢出某黑色物
　　体，正好在我的上方，我慌忙避开。黑色物体落在我刚才站的地点后，破碎了。
　　那是天竺葵的盆栽！
　　这是放学后，我走在教室大楼旁时发生的事。不知从何处飘来钢琴声。我呆然凝
　　视那破碎的陶盆，一瞬，无法理解发生什么事，直到腋下的汗珠沿手臂滴落，我才忽
　　然清醒过来。
　　紧接的瞬间，我拔腿往前跑。一冲进教室大楼，马上全力跑上楼梯。我激喘的站
　　在三楼走廊，不只是因为快跑才心跳急促，而是内心的恐惧已达到顶点。如果头顶被
　　刚才那一下击个正着，也会像天竺葵一样红花迸开？
　　从那扇窗户看来，会是哪间教室呢？我站在理科实验室前。里面飘出药物臭味的
　　空气，门开了约五公分。
　　我用力推开门，在这同时，一阵清爽的微风迎面吹过来。正面窗户敞开，白色窗帘随风
摇曳。我再度沿走廊前进。我不记得盆栽落下至我跑上这儿约莫经过多久，但是，我总觉得
走廊两侧并列的教室中，推落盆栽之人仍躲藏于其中一间。
　　教师大楼中央弯曲成L型，走过转角时，我停住了。从挂着“二年C班”牌子的教室内传
出说话声。
　　我毫不犹豫的推开门。
　　里面有五位学生，聚集在窗边似乎写些什么。见到我这突然的入侵者，一起回头。我不
得不说话了。
　　“你们在做什么？”        
　　这时，站在前面的学生回答：“我们是文艺创作社……正在制作诗集。”语气很肯定，
带有“别打扰我们”的意味。
　　“有谁来过这里吗？”
　　五个人相互看了一眼，摇头。
　　“没人经过走廊？”
　　她们再次互望一眼。似乎有人低声说“没有呀”，然后，刚刚那位学生代表大家回答：
“没注意到。”
　　“哦？那……谢谢。”我环视教室内一圈，关上门。直到那时，我才又听到钢琴声。对
了，感觉上好像自方才就一直听到，虽然我毫不懂古典乐曲，却是曾听过的曲子。我想：弹
奏得应该颇不错！
　　最里面有音乐教室，声音是从该教室内流泻出。
　　我打开所有教室之门，一一确定里边是否有人。最后，只剩下那间音乐教室。
　　我用力开门，声音恰似扰乱平静的流水，毁坏美观建筑物的杂音。钢琴声猛然止歇，弹
奏者很气愤状的注视着我。
　　那脸庞我有印象，是二年A班的学生。白皙的肌肤颇引人注目，但，此刻略显苍白。
　　我情不自禁说：“对不起？有人来过这里吗？”
　　一面问，我一面环视室内。有三排长椅子并列，两架斑驳的风琴靠着窗。墙上挂着在音
乐界留下功绩的名作曲家们之肖像。没有地方可以藏身？
　　她一句话也不说的摇摇头。她弹奏的是豪华型三脚钢琴，似是相当古老之物。
　　“是吗……？”
　　我绕至她身后，走至窗畔。可见到在校园内跑步的各社团的学生。走出音乐教室往左边
就有楼梯，偷袭我的人大概就是从那里逃走吧！以时间来说是绰绰有余。问题是，究竟会是
谁呢？
　　我注视到弹奏钢琴的女学生一直凝视着我，眼神里带有不安。
　　我勉强挤出笑容，说：“你继续弹奏吧！我想听一会儿。她的表情终于转为柔和，瞥了
乐谱一眼，手指流畅地动了，琴音由低转高……对了，是萧邦！
　　这是连我也知道的名曲。
　　边眺望窗外边聆赏萧邦——好个出乎意料之外的优雅享受。但，我的心情却无法开明，
依然是忧郁的。
　　距今约五年前，我进入杏坛。并非对教育特别有兴趣，也非憧憬着这项职业，简单的说
，只是“很自然”的结果。
　　本地某国立大学工学院资讯工程系毕业后，我在某家电厂就职，理由之一是总公司在这
里。但却被派遣至信州的研究所。还好工作内容是光纤通讯系统的开发设计，颇符合自己的
希望，所以工作了三年。
　　第四年，机会降临了。公司在东北建造新工厂，光纤通讯系统的成员大半数跟着被转调
该工厂，我当然也包括在内。
　　我踌躇了。印象中，东北太遥远了，一想到前辈同事半开玩笑半认真的话：“也许会一
辈子待在深山里头也不一定”。我的心就凉了大半截。我考虑换个职业，看是进其他企业，
或是干公务员。可是，事实并非想像中那般容易。我不免暗想：是否该死心的前赴东北？
　　就在此时，母亲劝我不如当教师。   
　　大学就学期间，我已取得数学教师资格，但，我却认为吃这行饭太没意思，想都没想要
靠它吃饭。
　　当然，以母亲的立场而言，她是不希望让儿子去东北那样偏僻的地方。不过事实上，从
薪水方面来看，与当时的平均收入相比，教师这项职业绝非不好。然而，要通过教员任用考
试并不容易。我一提到这点，母亲说：“私立学校也许行得通”，因为，先父和私立学校联
谊会有颇深的关系。
　　虽非特别想干的工作，也并不讨厌，这是我对教师这项职业的观念，因此在无更适合的
职业可让我拒绝母亲的热心劝诱之下，我只好答应了。不过，心理上仍只抱着试个两、三年
再说的念头。
　　翌年三月，我正式拿到聘书，学校名称是私立清华女子高等学校。这所高中位于S车站下
车步行约五分钟、四周皆为社区住宅和田地环绕的奇妙环境中。学生人数，每一年级三百六
十人，每四十五人一班，分为八班。有二十年上的传统，又维持颇高的升学率，以县内的女
子高中而论，算是顶尖学府。事实上，我告诉许多朋友说“要到清华女子高校当教师”时，
每个人都祝贺我，表示“选到最佳出路”。
　　向公司递上辞呈后，四月分开始，我即执起教鞭了。
　　第一天上课的情景，我记忆深刻？那是一年级的学生，因为我也是初次至这所学校，所
以曾自我介绍自己也该算是新生。
　　上完第一堂课，我很快就对教师这项职业失去自信。并非我有什么挫败，也非无法应付
学生，只是我受不了她们的视线。
　　我不认为自己是会引人注目之人，甚至可谓是习惯于躲在别人背后。可是，从事教师这
项职业却不能让你这样做，学生们对你的一言一行都会加以反应，对你的一举手、一投足也
都予以注目，而我很不能忍受上课时间被将近一百双眼眸监视的感觉。
　　直至约两年前，才逐渐习惯于她们的视线。也不是神经变得较粗、反应较迟钝，而是发
觉：学生们对所谓的教师，并非真的那样有兴趣。
　　但，我丝毫无法理解她们的心情。反正，令自己惊异的情事接二连三发生？我以为她们
是成年，却很意外的发现她们根本和小女孩没两样。然而她们又会惹出不逊于成年人的问题
，完全没办法预测其行动。关于这点，第一年的经验和第五年的经验皆同。不仅学生们，连
学校教师们也一样，在我这种干过其他行业之人的眼中看来，他们很多都像不同的生物。有
人为了管教学生，不停使用无意义的劳力，其至目露凶光、检查学生的服装、穿着，像这种
情形，我实在无法理解。
　　这五年来，我的感想是：所谓学校的这种地方，自己不懂之事太多了。
　　不过，最近我了解到一件事，那就是：在我周遭，存在着企图杀害我的人物！我是三天
前的早晨才注意到这种杀意。地点是在S车站的月台。我走出客满的电车，随着人群走在月台
边缘，忽然，有人从旁推了我一把。由于事出突然，我失去平衡，朝外侧踉跄了一、两步，
在掉下铁轨之前，总算站稳往脚，当时，距月台边缘已不到十公分了。我心想：好危险？到
底是谁呢？
　　感觉上，全身掠过一阵战栗。正好有一班快车驶过眼前的铁轨！
　　我确信是有人故意推我——估算好列车驶过的时间等待我不注意之际……
　　但，到底是谁呢？很遗憾，要自拥挤的人群中找出下手的人物，根本不可能。
　　第二次感觉到杀意是在昨天。由于游泳社停止练习，我独自在池里游泳——我很喜欢游
泳。我往返游了三趟五十公尺后，爬上来。由于还须指导射箭社的练习，不能让自己过度疲
倦。在池畔做过体操后，便去淋浴。虽然已经九月，连日来却酷热无比，淋过浴会清爽舒服
多了。
　　淋过浴、关上莲蓬头开关时，我发现“那件东西”。它掉在我脚边约一公尺外的地面，
不，因为积水深及脚踝，所以应该说是沉在水中。是个约莫拳头大小的白色小盒子。
　　我靠过脸去，仔细观察，然后，拔腿冲出淋浴室。那是家庭用一百伏特延长线的插座部
分，电线另一头则连接至更衣室，插着电。当然，进入游泳池前没有这种东西。那么，一定
是有人趁我游泳时放置的，目的是要让我触电致死。
　　但，为何我会平安无事呢？
　　我走向总开关，一看，果然如我所料，安全开关跳下来了。这是电流在水中的流量过大
，超出安全开关的容量，才导致安全开关跳下。如果换成更大容量的安全开关，那……
　　再来就是第三次，亦即刚才的天竺葵盆栽。
　　截至目前，三次都很幸运脱险了。但，幸运不见得会永远持续下去，终有一天，凶手会
狠心下手，而，在这之前，我必须查出凶手的真正身份。涉嫌者是名叫学校的集团——不知
身份究竟的人们之集团。
　　第二节
　　九月十一日，星期三。
　　第一节是三年C班的课，这是升学班。进入第二学期后，开始稍微有些人心惶惶的是就业
班，多少会全神贯注听讲的是升学班。
　　门一开，响起阵阵拉动椅子的哗啦声，几秒钟以后，所有学生就位。
　　“起立！”班长叫着。
　　穿清一色白衬衫的女学生站起，敬礼后坐下，教室内又是阵阵哗然。
　　我立刻翻开教科书。教师之中，也有人在正式授课之前会闲话家常者，但我硬是学不来
，连正常的讲课都感到痛苦了，何能说出多余的话来？
　　我想：能在数十人的注目下说话而不觉得痛苦，应该是一种才能！
　　“从五十二页开始。”我以干哑的声音说。
　　学生们最近似也了解我是什么样的教师，因而不再有任何期待了。因为除了和数学课业
有关的事以外，我什么话都不说，所以学生们替我取了个绰号——“机器”，大概是“教学
机器”的简称吧！
　　我左手拿教科书、右手拿粉笔，开始上课。
　　三角函数、微分、积分……很难确定她们之中有百分之几的人能听懂我授课的内容，并
非她们不时点头、频做笔记，就表示已经了解。每次测验，成绩总是烂得一塌糊涂。
　　课上到约过三分之一的时间，教室的后门突然开了。所有学生都回头，我也停住拿粉笔
的手望过去。
　　进来的是高原阳子。她虽受到所有人的注目，仍慢慢往前走，视线对准左侧最后面的自
己座位。当然，她连看我一眼也没有。
　　静寂中，她的足音回荡着。
　　“接下来是以代入法算不定积分……”
　　见到高原阳子入座后，我再次开始授课。我很清楚教室内的空气非常紧张。阳子被学校
勒令停止上课三天，听说是因抽烟被抓到，但是详细情形我不知道，只是听三年C班导师长谷
说过，她今天开始恢复上学。第一节课开始之前，长谷对我说：“刚才我点过名，但是高原
未到，我想她大概又旷课了。不过，她若是课上到一半才迟到，请你狠狠的训一顿。”
　　“我最不会教训学生了。”我坦白说。
　　“别这样说吧！你是她二年级时的导师，不是吗？”
　　“是……”
　　“那就请你责备她。”
　　“好吧！”我回答。          
　　但是，我丝毫不打算遵守和长谷之间的承诺。理由之一当然如自己所说的，不会教训学
生，另外则是：我实在不会应付像高原阳子这样的学生。去年，她是我当导师的二年B班学生
，但，却不是像现在这样的问题学生，只是精神方面和肉体方面都有些“前进”而已。
　　那是今年三月、结业典礼结束后的事。
　　我回到办公桌，正打算收拾一下后回家时，见到公事包上放着一张字条，上面写着：“
请来二年B班教室”。
　　没有写姓名，字迹相当端正。我猜不出究竟是谁找我，又为了什么事？但仍沿着无人的
走廊来到教室，推开教室门。
　　里面是阳子。她靠着站在讲桌边，面向我。
　　“阳子，是你找我？”我问。
　　她面无表情的点点头。
　　“什么事？是对数学成绩不满？”我开着不太习惯的玩笑。
　　但，阳子视若无睹，伸出右手，递给我一个白色信封：“我有事请老师帮忙。
　　“这是什么？是信吗？”
　　“不！你看了就知道。”
　　我打开信封一看，是三月二十五日九点开出的特快车车票，迄站是长野。
　　“我要到信州去，希望老师陪我。”
　　“信州？还有谁呢？”
　　“没有了。只是我们两人。”阳子像是闲话家常般的轻松回答。但，神情极端严肃！
　　“真令人惊讶！”我故意夸张的说，“为何找我？”
　　“这……我也不知道。”
　　“为什么去信州？”
　　“只是……没什么！你会去吧？”她的语气很肯定。
　　我摇头。
　　“为什么？”她似很意外。
　　“学校规定不能和特定学生做这种事。
　　“若是特定女人呢？”
　　“这……”我怔怔望着她。
　　“反正，三月二十五日我会在M车站等。”
　　“不行，我不会去的。”     
　　“你要来，因为我会等你。”说着，阳子不等我再开口，转身走向教室门口，然后回头
说，“否则，我会恨你一辈子的。”
　　话一说完，她突然跑出走廊。
　　我拿着放有车票的信封，呆立讲台上。
　　三月二十五日之前，我非常困惑。当然，我完全没有陪她旅行的念头，困惑的只是当天
该采取什么样的行动！也就是，我该漠视此事、让她在车站呆等吗？或是去车站说服她？
　　但，考虑及阳子的个性，我不认为当天她会听我之言打消去旅行的念头，所以就没有去
车站。我认为，她只要等一个钟头，就会死心回家了。
　　当天，我终究无法平静下心情，从早上就不停看着时间。当时针指着九点时，不知何故
，我深深叹息了。这是多磨漫长的一日呀！
　　当晚八点左右，电话铃声响了。我拿起话筒：“喂，我是前岛。”
　　“……”
　　我直觉认定是阳子：“是阳子吗？”
　　“……”
　　“还在等？”
　　她仍旧沉默不语。我脑海中浮现她那种表情——有话想说，却紧咬住下唇。
　　“如果没有事，我要挂断了。”
　　她还是没回答，所以我搁回话筒，但，即使这样，我仍觉得心头像是压了一块大石头。
春节过后，她们升上三年级，我有一段时间尽量不正面对着她。在走廊上见到她，我立刻回
头，上课时也极力不望向她。最近虽没再那般神经质的避开她，却……何况，阳子也是那段
时期才开始因为服装和上课态度，被校方认定是问题学生？
　　直到上完课，我终于连提醒她以后不能迟到也没说半句。不过，平常也有学生迟到，而
我同样没说话，因而其他学生也不觉不可思议。
　　回到教职员室，对长谷提起此事，他双眉紧锁，不断念着：“真是没办法？恢复上课的
第一天就迟到，根本瞧不起学校，这种时候若不狠狠训她……好吧！中午休息时间我会叫她
来训话。”
　　长谷拭着鼻尖的汗珠。他只比我大两、三岁，但是看起来更老。或许是少年白头、身材
又胖的关系吧？
　　这时，坐在隔壁的村桥开口了：“高原阳子上学了？”
　　这人说话的语气里总是带有双关意味，我很讨厌。
　　我点头：“是的。”
　　“真是乱七八糟？”他恨恨的说，“真不知她来学校干吗！她难道不明白这里并非她那
种害虫该来的地方？反正，只停学三天太纵容她了，有必要停学一星期，最好是一个月。不
过，即使这样也没用……”他边推推鼻梁上的金边眼镜，边说。我虽然不是特别具有正义感
，但是，村桥使用的“害虫”、“瘤”、“垃圾”之类的说法，很让我不快。
　　“她二年级的时候并没特别坏！”
　　“有些学生就是在最重要的时期才一百八十度剧变，算是一种逃避吧？做父母的也有问
题，根本没督促嘛！她父亲从事何种工作？”
　　“应该是K糕饼公司的经理吧？”我望向长谷。
　　他颌首：“不错。”
　　这时，村桥两道眉毛挤在一块，一副恍然的表情：“这是常有的情况。父亲过分忙碌，
没时间关心女儿的教育，却供应太多零用钱，形成最容易堕落的环境。”
　　“是吗？”
　　村桥是训导主任。他不停高谈阔论，我和长谷只是偶尔搭个腔。阳子的父亲很忙碌似乎
是事实。依我的记忆，她母亲在三年多前病逝，家事完全由女佣负责。不过，她几乎只是和
女佣共同生活，父亲很少待在家里。她说这些话时，脸上毫无黯然神色，或许内心很痛苦，
但，表情开明，完全未形诸于色！
　　“那么，母亲呢？”村桥问。
　　长谷回答。他连阳子母亲的死因是胃癌都知道。
　　“没有母亲？那可真糟糕，无可救药了。”
　　村桥不停摇头的站起来时，铃声响了，第二节课开始。我和长谷回自己的办公桌准备妥
当，走出教职员室。
　　途中，在走廊上，我和长谷闲聊。
　　“村桥老师还是那么严厉呢？”
　　“他是训导主任。”我说。
　　“话是这样没错，但……高原抽烟的事，好像是在洗手间偷偷进行的，却被他发现。”
　　“哦？是村桥老师？”
　　我是第一次听说。看来他果然看阳子很不顺眼了。
　　“学校决定处罚她停止上课三天时，只有他坚持一星期，最后，还是由校长决定。”
　　“原来如此。”`).replace(/\s+/g, " ");

export const comma = "，";
export const period = "。";
export const ellipsis = "…";
export const question = "？";
export const exclamation = "！";
export const semicolon = "；";
export const colon = "：";
export const dash = "—";
export const hyphen = "-";
export const newline = "\n";

export const commaRegexp = /,|，/;
export const periodRegexp = /\.|。/;
export const ellipsisRegexp = /…/;
export const questionRegexp = /\?|？/;
export const exclamationRegexp = /!|！/;
export const semicolonRegexp = /;|；/;
export const colonRegexp = /:|：/;
export const dashRegexp = /—/;
export const hyphenRegexp = /-/;
export const newlineRegexp = /\n/;

function cleanUpText(input: string) {
  // Replace sequences of newline and indentations with a single space
  input = input.replace(/[\u3000\n]+\u3000*/g, " ");

  // Replace newlines not followed by a Chinese punctuation mark or space with a space
  input = input.replace(/([^。！？])\n([^。！？])/g, "$1$2");

  return input;
}

const allPunctuation = new RegExp(
  `${commaRegexp.source}|${periodRegexp.source}|${ellipsisRegexp.source}|${questionRegexp.source}|${exclamationRegexp.source}|${semicolonRegexp.source}|${colonRegexp.source}|${dashRegexp.source}|${hyphenRegexp.source}`,
  "g"
);

export function removePunctuation(input: string) {
  // Replace multiple spaces with a single space
  input = input.replace(/\s+/g, " ");

  // Trim any leading or trailing spaces
  input = input.trim();
  return input.replace(allPunctuation, "");
}

export function useParagraphs() {
  const paragraphs = React.useMemo(() => {
    const sections = sentence.split("\n");

    const localeMapping = {
      eng: "en_US", // English
      cmn: "zh_CN", // Simplified Chinese (Mandarin)
    } as const;
    const locale = franc(sections[0] ?? "") as keyof typeof localeMapping;

    const period = locale === "cmn" ? "。" : ".";
    const periodConversation = locale === "cmn" ? "。”" : ".";

    const questionMark = locale === "cmn" ? "？" : "?";
    const questionMarkConversation = locale === "cmn" ? "？”" : "?";

    const exclamationMark = locale === "cmn" ? "！" : "!";
    const exclamationMarkConversation = locale === "cmn" ? "！”" : "!";

    let paragraphs = sections
      .map((paragraph) => paragraph.split(periodConversation))
      .map((paragraph) => {
        return paragraph.map((sentence, index) => {
          if (index === paragraph.length - 1) {
            return sentence;
          }
          return (sentence + periodConversation).trim();
        });
      });

    // paragraphs = splitByPunctuationConversation(paragraphs, questionMarkConversation);

    // paragraphs = splitByPunctuationConversation(paragraphs, exclamationMarkConversation);

    paragraphs = splitByPunctuation(paragraphs, questionMark);

    paragraphs = splitByPunctuation(paragraphs, period);

    paragraphs = splitByPunctuation(paragraphs, exclamationMark);

    // paragraphs = adjustParagraph(paragraphs);

    return paragraphs;
  }, []);

  const sentences = React.useMemo(() => paragraphs.flat(), [paragraphs]);

  return { paragraphs, sentences };
}

function splitByPunctuationConversation(paragraphs: string[][], punctuation: string) {
  return paragraphs.map((paragraph) => {
    return paragraph
      .map((sentence) => {
        return sentence.split(punctuation);
      })
      .map((paragraph) =>
        paragraph.map((sentence, index) => {
          if (index === paragraph.length - 1) {
            return sentence;
          }
          return (sentence + punctuation).trim();
        })
      )
      .flat()
      .filter((paragraph) => paragraph !== "");
  });
}

function splitByPunctuation(paragraphs: string[][], punctuation: string) {
  return paragraphs.map((paragraph) => {
    return paragraph.flatMap((sentence) => {
      // Check if the sentence is wrapped with “ and ”
      if (sentence.startsWith("“") && sentence.endsWith("”")) {
        return [sentence]; // Return the entire sentence as-is
      }

      // Split the sentence by the punctuation outside of quotations
      let parts = [];
      let insideQuotes = false;
      let currentPart = "";

      for (let i = 0; i < sentence.length; i++) {
        if (sentence[i] === "“") {
          insideQuotes = true;
          currentPart += sentence[i];
        } else if (sentence[i] === "”") {
          insideQuotes = false;
          currentPart += sentence[i];
        } else if (insideQuotes) {
          currentPart += sentence[i];
        } else if (punctuation.includes(sentence[i])) {
          if (currentPart.trim() !== "") {
            parts.push(currentPart.trim() + punctuation); // Add punctuation
            currentPart = "";
          }
        } else {
          currentPart += sentence[i];
        }
      }

      // Push the last part
      if (currentPart.trim() !== "") {
        parts.push(currentPart.trim());
      }

      return parts;
    });
  });
}

function adjustParagraph(paragraphs: string[][]) {
  return (paragraphs = paragraphs
    .map((paragraph) => {
      let adjustedParagraph = [];

      for (let i = 0; i < paragraph.length; i++) {
        let current = paragraph[i];

        if (current === "”" && i > 0) {
          adjustedParagraph[adjustedParagraph.length - 1] += current;
        } else if (current.endsWith("”")) {
          adjustedParagraph[adjustedParagraph.length - 1] += current;
        } else {
          adjustedParagraph.push(current);
        }
      }

      return adjustedParagraph;
    })
    .filter((paragraph) => paragraph.length > 0));
}
